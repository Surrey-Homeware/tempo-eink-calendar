  <div class="card-head">
    <h2 class="section-title">Calendar Settings</h2>
  </div>

  <div class="card-body form">
    <!-- Calendars -->
    <div class="form-section">
      <label class="form-label block">Calendar iCal Links (<a href="{{ url_for('playlist.calendar_help') }}"target="_blank">Help</a>)</label>

      <div id="calendarList" class="stack" aria-live="polite"></div>

      <button
        type="button"
        id="addCalendarBtn"
        class="btn btn-outline"
        onclick="addCalendarInput('', '#007BFF')"
      >
        <!-- plus icon -->
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6z"/>
        </svg>
        <span>Add calendar iCal link</span>
      </button>
    </div>

    <!-- Layout + Language -->
    <div class="form-section">
      <div class="form-row" style="display: none;">
        <label class="form-label">Calendar Display Style</label>
        <div class="segmented" id="viewSelector" role="group" aria-label="Layout">
          <button type="button" data-value="listMonth" onclick="selectView(this)">List of events</button>
          <button type="button" data-value="timeGridDay" onclick="selectView(this)">Current Day</button>
          <button type="button" data-value="timeGridWeek" onclick="selectView(this)">Current Week</button>
          <button type="button" data-value="dayGridMonth" onclick="selectView(this)">Current Month</button>
        </div>
      </div>

      <input type="hidden" name="viewMode" id="viewMode" value="timeGridDay" />

      <div class="form-row">
        <label for="language" class="form-label">Display Language</label>
        <select id="language" name="language" class="form-input">
          {% for code, name in locale_map.items() %}
            <option value="{{ code }}">{{ name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Display -->
    <div class="form-section">
      <label class="form-label block">Display</label>

      <label class="check-row">
        <input type="checkbox" id="displayTitle" name="displayTitle" value="true"
               checked onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Title</span>
      </label>

      <label class="check-row">
        <input type="checkbox" id="displayWeekends" name="displayWeekends" value="true"
               checked onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Weekends</span>
      </label>

      <label class="check-row">
        <input type="checkbox" id="displayEventTime" name="displayEventTime" value="true"
               checked onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Event time</span>
      </label>

      <div class="check-row" data-visible-modes="timeGridDay,timeGridWeek">
        <label class="check-inline">
          <input type="checkbox" id="displayNowIndicator" name="displayNowIndicator" value="true"
                 checked onclick="this.value=this.checked ? 'true' : 'false';">
          <span>Now indicator</span>
        </label>
        <label class="color-inline">
          <input type="color" id="nowIndicatorColor" name="nowIndicatorColor" class="color-picker" value="#ff0000" aria-label="Now indicator color">
        </label>
      </div>

      <label class="check-row" data-visible-modes="timeGridWeek">
        <input type="checkbox" id="displayPreviousDays" name="displayPreviousDays" value="true"
               checked onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Previous days</span>
      </label>
    </div>

    <!-- Week start / Interval / Font size -->
    <div class="form-section grid-2">
      <div class="form-row nowrap" data-visible-modes="timeGridWeek,dayGridMonth">
        <label for="weekStartDay" class="form-label">Week start</label>
        <select id="weekStartDay" name="weekStartDay" class="form-input">
          <option value="0">Sunday</option>
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>
      </div>

      <div class="form-row nowrap" data-visible-modes="timeGridDay,timeGridWeek">
        <label for="interval" class="form-label">Time interval</label>
        <div class="range-pair">
          <input type="number" id="startTimeInterval" name="startTimeInterval" class="form-input" min="0" max="24" placeholder="00" inputmode="numeric">
          <span class="range-sep">–</span>
          <input type="number" id="endTimeInterval" name="endTimeInterval" class="form-input" min="0" max="24" placeholder="24" inputmode="numeric">
        </div>
      </div>

      <div class="form-row nowrap" style="display: none;">
        <label for="fontSize" class="form-label">Font size</label>
        <select id="fontSize" name="fontSize" class="form-input">
          <option value="x-small">Extra Small</option>
          <option value="smaller">Smaller</option>
          <option value="small">Small</option>
          <option value="normal">Normal</option>
          <option value="large">Large</option>
          <option value="larger">Larger</option>
          <option value="x-large">Extra Larger</option>
        </select>
      </div>
    </div>
  </div>

<script>
    function selectView(button) {
      // Remove 'active' from all buttons
      const buttons = document.querySelectorAll('#viewSelector button');
      buttons.forEach(btn => btn.classList.remove('active'));

      // Add 'active' to the clicked button
      button.classList.add('active');

      // Set hidden input value from button's data-value
      const value = button.getAttribute('data-value');
      document.getElementById('viewMode').value = value;

      updateViewDependentOptions(value);
    }

    function updateViewDependentOptions(viewMode) {
        const conditionals = document.querySelectorAll('[data-visible-modes]');

        conditionals.forEach(el => {
            const allowedViews = el.getAttribute('data-visible-modes').split(',');
            const shouldShow = allowedViews.includes(viewMode);

            el.style.display = shouldShow ? '' : 'none';

            // Enable or disable all inputs inside the element
            const inputs = el.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = !shouldShow;
            });
        });
    }

    function addCalendarInput(url = '', color = '#007BFF') {
        const calendarList = document.getElementById('calendarList');

        const wrapper = document.createElement('div');
        wrapper.classList.add('calendar-entry');
        wrapper.classList.add('form-group');

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.name = 'calendarColors[]';
        colorInput.classList.add('color-picker')
        colorInput.value = color;

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.name = 'calendarURLs[]';
        urlInput.placeholder = 'Calendar URL';
        urlInput.required = true;
        urlInput.classList.add('form-input');
        urlInput.value = url;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.innerText = '✕';
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => wrapper.remove();

        wrapper.appendChild(colorInput);
        wrapper.appendChild(urlInput);
        wrapper.appendChild(removeBtn);

        calendarList.appendChild(wrapper);
    }

    // populate form values from plugin settings
    document.addEventListener('DOMContentLoaded', () => {
        const viewModeInput = document.getElementById('viewMode');
        const viewButtons = document.querySelectorAll('#viewSelector button');

        // defaults
        let viewMode = "dayGridMonth";
        let language = "en";
        let calendars = [{ url: '', color: '#007BFF' }];
        let fontSize = "normal";

        if (loadPluginSettings) {
            viewMode = pluginSettings.viewMode;
            language = pluginSettings.language;
            fontSize = pluginSettings.fontSize;

            document.getElementById('displayTitle').checked = pluginSettings.displayTitle;
            document.getElementById('displayTitle').value = pluginSettings.displayTitle;

            document.getElementById('displayWeekends').checked = pluginSettings.displayWeekends;
            document.getElementById('displayWeekends').value = pluginSettings.displayWeekends;

            document.getElementById('displayEventTime').checked = pluginSettings.displayEventTime;
            document.getElementById('displayEventTime').value = pluginSettings.displayEventTime;

            document.getElementById('displayNowIndicator').checked = pluginSettings.displayNowIndicator;
            document.getElementById('displayNowIndicator').value = pluginSettings.displayNowIndicator;
            document.getElementById('nowIndicatorColor').value = pluginSettings.nowIndicatorColor;

            document.getElementById('displayPreviousDays').checked = pluginSettings.displayPreviousDays;
            document.getElementById('displayPreviousDays').value = pluginSettings.displayPreviousDays;

            document.getElementById('weekStartDay').value = pluginSettings.weekStartDay;

            document.getElementById("startTimeInterval").value = pluginSettings.startTimeInterval;
            document.getElementById("endTimeInterval").value = pluginSettings.endTimeInterval;

            if (pluginSettings["calendarURLs[]"]) {
                calendars = pluginSettings["calendarURLs[]"].map((url, i) => ({
                    url: url || '',
                    color: pluginSettings["calendarColors[]"][i]  || '#007BFF'
                }));
            }
        }

        // populate view mode
        viewModeInput.value = viewMode
        viewButtons.forEach(btn => {
            if (btn.getAttribute('data-value') === viewMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // populate language dropdown
        document.getElementById('language').value = language;
        document.getElementById('fontSize').value = fontSize;

        // populate calendars
        calendars.forEach(({ url, color }) => {
            addCalendarInput(url, color);
        });

        updateViewDependentOptions(viewMode)
    });
</script>