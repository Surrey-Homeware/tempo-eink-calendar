<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plugin.display_name }} Settings</title>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    <!-- Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>

    <script>
        const pluginSettings = {{ plugin_settings | tojson if plugin_settings else {} }};
        const pluginInstanceName ='{{ plugin_instance }}';
        const loadPluginSettings = pluginInstanceName != '';
        const styleSettings = {{ style_settings | default(false) | tojson }};

        let uploadedFiles = {};

        async function handleAction(action) {
            // Gather plugin settings form data
            const form = document.getElementById('settingsForm');
            const scheduleForm = document.getElementById('scheduleForm');

            const formData = new FormData(form);
            let url = '{{ url_for("plugin.update_now") }}';
            let method = 'POST';
            let clearFormOnSubmit = true;
            
            // Add uploaded files to the form under its key
            Object.keys(uploadedFiles).forEach(key => {
                if (uploadedFiles[key].length > 0) {
                    uploadedFiles[key].forEach(file => {
                        formData.append(key, file);
                    });
                }
            });

            if (action == "update_instance") {
                url = "{{ url_for('plugin.update_plugin_instance', instance_name='') }}" + pluginInstanceName,
                method = 'PUT'
                clearFormOnSubmit = false
            }

            // Send data to the server
            try {
                const response = await fetch(url, {method: method, body: formData});
                const result = await response.json();
                // Handle the response
                if (response.ok) {
                    // Navigate to previous page
                    history.back()
                    //showResponseModal('success', `Success! ${result.message}`);
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }

                if (clearFormOnSubmit) {
                    form.reset()
                    uploadedFiles = {};
                    document.querySelectorAll('input[clear-on-submit]').forEach(input => {
                        input.value = '';
                        input.dispatchEvent(new Event('change'));
                    });
                    document.querySelectorAll('[delete-on-submit]').forEach(div => {
                        div.remove();
                    });
                    if (action == "add_to_playlist"){
                        scheduleForm.reset()
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            }
        }

        // Close modal if the user clicks outside the modal content
        window.onclick = function (event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector(".collapsible-icon");
            button.classList.toggle("active");
            content.style.display = content.style.display === "block" ? "none" : "block";
            icon.textContent = content.style.display === "block" ? "▲" : "▼";
        }

        function showFileName() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const fileNameText = document.getElementById('fileNameText');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');
            const removeFileButton = document.getElementById('removeFileButton');
            const file = fileInput.files[0];

            if (file) {
                fileNameText.textContent = `${file.name}`;
                fileNameDisplay.style.display = 'flex';  // Show the file name and remove button
                uploadButtonLabel.style.display = 'none';  // Hide the upload button label
            } else {
                fileNameDisplay.style.display = 'none';  // Hide if no file is selected
                uploadButtonLabel.style.display = 'block';  // Show the upload button label
            }
        }

        function removeFile() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');

            fileInput.value = '';  // Clear the file input
            fileNameDisplay.style.display = 'none';  // Hide the file name and remove button
            uploadButtonLabel.style.display = 'block';  // Show the upload button label

            const hiddenElement = document.getElementById(`hidden-file-name`);
            if (hiddenElement) {
                hiddenElement.remove();
            }
        }

        // populate form values from plugin settings
        document.addEventListener('DOMContentLoaded', () => {
            if (!styleSettings){
                return;
            }
            if (loadPluginSettings) {
                if (pluginSettings.topMargin) {
                    document.getElementById('topMargin').value = pluginSettings.topMargin;
                }
                if (pluginSettings.bottomMargin) {
                    document.getElementById('bottomMargin').value = pluginSettings.bottomMargin;
                }
                if (pluginSettings.leftMargin) {
                    document.getElementById('leftMargin').value = pluginSettings.leftMargin;
                }
                if (pluginSettings.rightMargin) {
                    document.getElementById('rightMargin').value = pluginSettings.rightMargin;
                }
                // Populate background options (color or image)
                if (pluginSettings.backgroundOption) {
                    document.querySelector(`input[name="backgroundOption"][value="${pluginSettings.backgroundOption}"]`).checked = true;
                }

                // Set background color
                if (pluginSettings.backgroundColor) {
                    document.getElementById('backgroundColor').value = pluginSettings.backgroundColor;
                }

                // Populate text color
                if (pluginSettings.textColor) {
                    document.getElementById('textColor').value = pluginSettings.textColor;
                }

                // Handle background image selection
                const fileNameDisplay = document.getElementById('fileName');
                const fileNameText = document.getElementById('fileNameText');
                const uploadButtonLabel = document.getElementById('uploadButtonLabel');

            } else {
            }
        });
    </script>
</head>
<body>
    <div class="frame">
        <!-- Include plugin settings -->
  <header class="app-header">
    <div class="container header-inner">
      <div class="header-left">
        <h1 class="title">Calendar Settings</h1>
      </div>
    </div>
  </header>

        <form id = "settingsForm" class="settings-form" onsubmit="return false;">
            <main class="container main-grid">
                <section class="card settings-card">

                    {% include settings_template %}

                    <!-- Hidden input to pass plugin id -->
                    <input type="hidden" name="plugin_id" value="{{ plugin.id }}">

                    <div class="card-foot">
                        <a href="javascript:history.back()" class="btn btn-outline" aria-label="Go back">
                          <span>Cancel</span>
                        </a>
                        <div class="foot-spacer"></div>
                        <button type="button" class="btn btn-primary" onclick="handleAction('update_instance')">
                            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 13h14v-2H5v2Zm0 6h14v-2H5v2ZM5 7h14V5H5v2Z"/></svg>
                            <span>Save changes</span>
                        </button>
                    </div>
                </section>
            </main>

        </form>
    </div>

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}
</body>
</html>
