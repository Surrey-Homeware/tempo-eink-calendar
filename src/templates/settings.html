<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>System Settings</title>

  <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/main.css') }}"/>

  <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
  <script>
    async function handleAction() {
      const form = document.querySelector('.settings-form');
      const formData = new FormData(form);
      try {
        const response = await fetch("{{ url_for('settings.save_settings') }}", { method: 'POST', body: formData });
        const result = await response.json();
        if (response.ok) {
          showResponseModal('success', `Success! ${result.message}`);
          history.back();
        } else {
          showResponseModal('failure', `Error!  ${result.error}`);
          form.reset();
        }
      } catch (error) {
        console.error('Error:', error);
        showResponseModal('failure', 'An error occurred while processing your request.');
      }
    }

    let pluginCycleIntervalSeconds = {{ device_settings.plugin_cycle_interval_seconds | default(3600) | tojson }};

    function populateIntervalFields() {
      const intervalInput = document.getElementById('interval');
      const unitSelect = document.getElementById('unit');
      if (pluginCycleIntervalSeconds !== null && pluginCycleIntervalSeconds !== undefined) {
        let minutes = Math.floor(pluginCycleIntervalSeconds / 60);
        let hours = Math.floor(pluginCycleIntervalSeconds / 3600);
        if (hours > 0) { intervalInput.value = hours; unitSelect.value = "hour"; }
        else { intervalInput.value = minutes; unitSelect.value = "minute"; }
      }
    }

    function toggleCollapsible(button) {
      const content = button.nextElementSibling;
      const icon = button.querySelector(".collapsible-icon");
      button.classList.toggle("active");
      const open = content.style.display === "block" ? false : true;
      content.style.display = open ? "block" : "none";
      icon.textContent = open ? "▲" : "▼";
    }

    async function handleShutdown(reboot) {
      if (reboot) {
        showResponseModal('success', 'The system is rebooting. The UI will be unavailable until the reboot is complete.');
      } else {
        showResponseModal('success', 'The system is shutting down. The UI will remain unavailable until it is manually restarted.');
      }
      await new Promise(r => setTimeout(r, 1000));
      await fetch("{{ url_for('settings.shutdown') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({reboot})
      });
    }

    function updateSliderValue(slider) {
      const valueDisplay = document.getElementById(`${slider.id}-value`);
      valueDisplay.textContent = parseFloat(slider.value).toFixed(1);
    }

    document.addEventListener('DOMContentLoaded', populateIntervalFields);
  </script>
</head>
<body>
  <!-- Top bar -->
  <header class="app-header">
    <div class="container header-inner">
      <div class="header-left">
        <h1 class="title">System Settings</h1>
      </div>
      <div class="header-actions">
        <a class="btn btn-outline" href="{{ url_for('settings.download_logs', hours=24) }}" download>
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2ZM12 2v12l4-4 1.41 1.41L12 17.83l-5.41-5.42L8 10l4 4V2h0Z"/></svg>
          <span>Download Logs</span>
        </a>
        <button class="btn btn-warning" onclick="handleShutdown(true)">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M13 3h-2v8h2V3Zm5.65 3.35A8 8 0 1 1 5.35 6.35l1.41 1.41A6 6 0 1 0 17.24 7.76l1.41-1.41Z"/></svg>
          <span>Reboot</span>
        </button>
        <button class="btn btn-danger" onclick="handleShutdown(false)">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M13 3h-2v10h2V3Zm-1 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z"/></svg>
          <span>Shutdown</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container main-grid">
    <section class="card settings-card">
      <div class="card-head">
        <h2 class="section-title">Device</h2>
      </div>

      <form class="card-body form settings-form" autocomplete="off">
        <!-- Device Name -->
        <div class="form-row">
          <label for="deviceName" class="form-label">Device Name</label>
          <input type="text" id="deviceName" name="deviceName" class="form-input" placeholder="Type something..." value="{{ device_settings.name }}" required />
        </div>

        <!-- Orientation + Invert -->
        <div class="form-row">
          <label for="orientation" class="form-label">Orientation</label>
          <div class="grid-inline">
            <select id="orientation" name="orientation" class="form-input">
              <option value="horizontal" {% if device_settings.orientation == "horizontal" %}selected{% endif %}>Horizontal</option>
              <option value="vertical" {% if device_settings.orientation == "vertical" %}selected{% endif %}>Vertical</option>
            </select>

            <label class="check-row slim" style="display: none;">
              <input type="checkbox" id="invertImage" name="invertImage" {% if device_settings.inverted_image %}checked{% endif %}>
              <span>Invert image</span>
            </label>
          </div>
        </div>

        <!-- Timezone + Time format -->
        <div class="form-row">
          <label for="timezone" class="form-label">Time Zone</label>
          <div class="grid-inline">
            <input
              type="text"
              id="timezone"
              name="timezoneName"
              class="form-input"
              list="timezoneList"
              placeholder="Type to search…"
              value="{{ device_settings.timezone }}"
            />
            <datalist id="timezoneList">
              {% for timezone in timezones %}
                <option value="{{ timezone }}"></option>
              {% endfor %}
            </datalist>

            <select id="timeFormat" name="timeFormat" class="form-input">
              <option value="12h" {% if device_settings.time_format == "12h" %}selected{% endif %}>12 Hour (AM/PM)</option>
              <option value="24h" {% if device_settings.time_format == "24h" %}selected{% endif %}>24 Hour</option>
            </select>
          </div>
        </div>

        <!-- Plugin Cycle Interval + Log Stats -->
        <div class="form-row">
          <label for="interval" class="form-label">Screen Update Frequency</label>
          <div class="grid-inline">
            <span></span>
            <span class="muted">Unit</span>
            <input type="number" id="interval" name="interval" class="form-input" required min="1" inputmode="numeric">
            <select id="unit" name="unit" class="form-input" required>
              <option value="minute">Minute</option>
              <option value="hour">Hour</option>
            </select>

            <label class="check-row slim" style="display: none;">
              <input type="checkbox" id="logSystemStats" name="logSystemStats" {% if device_settings.log_system_stats %}checked{% endif %}>
              <span>Log system stats</span>
            </label>
          </div>
        </div>

        <!-- Collapsible Image Settings -->
        <div class="collapsible" style="display: none;">
          <button type="button" class="collapsible-header" onclick="toggleCollapsible(this)">
            <span>Image Settings</span>
            <span class="collapsible-icon">▼</span>
          </button>

          <div class="collapsible-content" style="display:none">
            <div class="slider-row">
              <label for="saturation" class="form-label">Saturation</label>
              <div class="slider-wrap">
                <span id="saturation-value" class="slider-value">{{ device_settings.get('image_settings', {}).get('saturation', 1.0) }}</span>
                <input type="range" id="saturation" name="saturation" min="0" max="2" step="0.1"
                       class="range" value="{{ device_settings.get('image_settings', {}).get('saturation', 1.0) }}"
                       oninput="updateSliderValue(this)"/>
              </div>
            </div>

            <div class="slider-row">
              <label for="contrast" class="form-label">Contrast</label>
              <div class="slider-wrap">
                <span id="contrast-value" class="slider-value">{{ device_settings.get('image_settings', {}).get('contrast', 1.0) }}</span>
                <input type="range" id="contrast" name="contrast" min="0" max="2" step="0.1"
                       class="range" value="{{ device_settings.get('image_settings', {}).get('contrast', 1.0) }}"
                       oninput="updateSliderValue(this)"/>
              </div>
            </div>

            <div class="slider-row">
              <label for="sharpness" class="form-label">Sharpness</label>
              <div class="slider-wrap">
                <span id="sharpness-value" class="slider-value">{{ device_settings.get('image_settings', {}).get('sharpness', 1.0) }}</span>
                <input type="range" id="sharpness" name="sharpness" min="0" max="2" step="0.1"
                       class="range" value="{{ device_settings.get('image_settings', {}).get('sharpness', 1.0) }}"
                       oninput="updateSliderValue(this)"/>
              </div>
            </div>

            <div class="slider-row">
              <label for="brightness" class="form-label">Brightness</label>
              <div class="slider-wrap">
                <span id="brightness-value" class="slider-value">{{ device_settings.get('image_settings', {}).get('brightness', 1.0) }}</span>
                <input type="range" id="brightness" name="brightness" min="0" max="2" step="0.1"
                       class="range" value="{{ device_settings.get('image_settings', {}).get('brightness', 1.0) }}"
                       oninput="updateSliderValue(this)"/>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="card-foot">
        <a href="javascript:history.back()" class="btn btn-outline" aria-label="Go back">
            <span>Cancel</span>
        </a>
        <div class="foot-spacer"></div>
        <button type="button" class="btn btn-primary" onclick="handleAction()">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 13h14v-2H5v2Zm0 6h14v-2H5v2ZM5 7h14V5H5v2Z"/></svg>
          <span>Save changes</span>
        </button>
      </div>
    </section>
  </main>

  {% include 'response_modal.html' %}
</body>
</html>
