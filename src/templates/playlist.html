<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tempo â€¢ Configuration</title>

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/main.css') }}" />

    <!-- Existing modal script -->
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>

    <script>
        async function displayPluginInstance(playlistName, pluginId, pluginInstance) {
            const refreshBtn = document.getElementById('refresh-now-btn');
            const original = refreshBtn.innerHTML;
            refreshBtn.disabled = true;
            refreshBtn.classList.add('is-loading');

            try {
                const response = await fetch("{{ url_for('plugin.display_plugin_instance') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        playlist_name: playlistName,
                        plugin_id: pluginId,
                        plugin_instance: pluginInstance
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                    location.reload();
                } else {
                    showResponseModal('failure', `Error! ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while processing your request.');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('is-loading');
                refreshBtn.innerHTML = original;
            }
        }

        function openModal() {
            const modal = document.getElementById('playlistModal');
            modal.style.display = 'block';
        }
        function closeModal() {
            const modal = document.getElementById('playlistModal');
            modal.style.display = 'none';
        }

        window.addEventListener("load", function () {
            let storedMessage = sessionStorage.getItem("storedMessage");
            if (storedMessage) {
                let { type, text } = JSON.parse(storedMessage);
                showResponseModal(type, text);
                sessionStorage.removeItem("storedMessage");
            }
        });
    </script>
</head>
<body>
    <header class="app-header">
        <div class="container header-inner">
            <h1 class="title">Tempo</h1>
        </div>
    </header>

    <main class="container main-grid">
        <!-- Preview Card -->
        <section class="card preview-card">
            <div class="card-head">
                <h2 class="section-title">Live Preview</h2>
                <div class="status-group">
                    {% if plugin_instance.latest_refresh_time %}
                        {% set refresh_time = plugin_instance.latest_refresh_time | format_relative_time %}
                        <span class="pill" role="status" aria-live="polite">
                            <!-- Sparkle icon -->
                            <svg class="icon xs" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M12 2l2 5 5 2-5 2-2 5-2-5-5-2 5-2 2-5z"/>
                            </svg>
                            Refreshed {{ refresh_time }}
                        </span>
                    {% else %}
                        <span class="pill pill-muted" role="status">No refresh data</span>
                    {% endif %}
                </div>
            </div>

            <div class="preview-wrap">
                <img
                    class="preview-image"
                    src="{{ url_for('static', filename='images/current_image.png') }}"
                    alt="Current image displayed on the E-ink screen"
                    decoding="async"
                    loading="eager"
                />
            </div>

            <div class="card-foot">
                <div class="foot-spacer"></div>
                <button
                    id="refresh-now-btn"
                    class="btn btn-primary"
                    title="Refresh display now"
                    onclick="displayPluginInstance('{{ playlist.name }}','{{ plugin_instance.plugin_id }}','{{ plugin_instance.name }}')"
                >
                    <!-- Refresh icon -->
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M17.65 6.35A8 8 0 1 0 20 12h-2a6 6 0 1 1-1.76-4.24L14 10h6V4l-2.35 2.35Z"/>
                    </svg>
                    <span>Refresh E-ink display now</span>
                </button>
            </div>
        </section>

        <!-- Details Card -->
        <aside class="card info-card">
            <div class="card-head">
                <h2 class="section-title">Configuration</h2>
            </div>
            <ul class="list">
                <li>
                    <a class="row-link" href="{{ url_for('playlist.calendar_help') }}"target="_blank">
                        <div class="row-text">
                            <div class="row-title">Instructions</div>
                            <div class="row-subtitle">How to add your online calendar to this display</div>
                        </div>
                        <svg class="icon chevron" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M9 6l6 6-6 6"/>
                        </svg>
                    </a>
                </li>
                <li>
                    <a class="row-link" href="{{ url_for('settings.settings_page') }}">
                        <div class="row-text">
                            <div class="row-title">System settings</div>
                            <div class="row-subtitle">Timezone, refresh frequency, orientation</div>
                        </div>
                        <svg class="icon chevron" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M9 6l6 6-6 6"/>
                        </svg>
                    </a>
                </li>
                <li>
                    <a class="row-link" href="{{ url_for('plugin.plugin_page', plugin_id=plugin_instance.plugin_id) }}?instance={{ plugin_instance.name }}">
                        <div class="row-text">
                            <div class="row-title">Calendar settings</div>
                            <div class="row-subtitle">Calendars to show, calendar style, language</div>
                        </div>
                        <svg class="icon chevron" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M9 6l6 6-6 6"/>
                        </svg>
                    </a>
                </li>
            </ul>
        </aside>
    </main>

    <footer class="container footer">
        <small></small>
    </footer>

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}
</body>
</html>
